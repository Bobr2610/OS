# Понятие взаимоблокировки (Deadlock)

---

## Вопрос 27: Условия возникновения. Моделирование взаимоблокировок. Способы борьбы со взаимоблокировками.

### Определение
**Взаимоблокировка (Deadlock)** — ситуация, при которой группа процессов блокирует друг друга, так как каждый процесс удерживает ресурс и ждет освобождения другого ресурса, занятого другим процессом из этой же группы.

### Условия возникновения (Условия Коффмана)
Взаимоблокировка возможна только при одновременном выполнении 4 условий:
1.  **Взаимное исключение (Mutual Exclusion)**: Ресурсы не могут использоваться совместно (доступ эксклюзивен).
2.  **Удержание и ожидание (Hold and Wait)**: Процесс, удерживающий минимум один ресурс, может запрашивать новые ресурсы, занятые другими процессами.
3.  **Отсутствие вытеснения (No Preemption)**: Ресурс не может быть отобран у процесса принудительно; он освобождается только добровольно.
4.  **Циклическое ожидание (Circular Wait)**: Существует замкнутая цепь процессов $\{P_0, P_1, ..., P_n\}$, где $P_0$ ждет ресурс, занятый $P_1$, $P_1$ ждет ресурс $P_2$, ..., а $P_n$ ждет ресурс $P_0$.

### Моделирование взаимоблокировок
Для анализа используется **Граф распределения ресурсов (Resource Allocation Graph)**:
*   **Вершины**: Процессы ($P$) и Ресурсы ($R$).
*   **Ребра**:
    *   $P_i \to R_j$ (Запрос): Процесс $i$ просит ресурс $j$.
    *   $R_j \to P_i$ (Владение): Ресурс $j$ занят процессом $i$.

**Признак дедлока**:
*   Если в графе **нет циклов** — дедлока нет.
*   Если есть цикл и каждый ресурс имеет **один экземпляр** — дедлок **гарантирован**.
*   Если есть цикл, но у ресурсов несколько экземпляров — дедлок **возможен**.

### Способы борьбы со взаимоблокировками

#### 1. Пренебрежение (Страус-алгоритм)
*   **Суть**: Игнорировать проблему, предполагая, что дедлоки случаются редко.
*   **Применение**: Windows, Linux (для пользовательских процессов). Если процесс завис, пользователь убивает его вручную.

#### 2. Предотвращение (Deadlock Prevention)
*   **Суть**: Сделать невозможным выполнение хотя бы одного из 4 условий Коффмана.
*   **Методы**:
    *   *Против удержания и ожидания*: Требовать захвата всех ресурсов сразу перед началом работы. (Минус: неэффективное использование ресурсов).
    *   *Против циклического ожидания*: Упорядочить ресурсы (дать номера) и требовать захвата строго по возрастанию номеров.

#### 3. Избегание (Deadlock Avoidance)
*   **Суть**: Система анализирует каждый запрос ресурса и одобряет его только если это не приведет к **небезопасному состоянию**.
*   **Метод**: **Алгоритм банкира (Banker's Algorithm)**. Требует знания заранее максимального количества ресурсов, которые понадобятся каждому процессу.

#### 4. Обнаружение и восстановление (Detection and Recovery)
*   **Суть**: Позволить дедлокам случаться, периодически запускать алгоритм поиска циклов в графе ожидания и устранять их.
*   **Восстановление**:
    *   Принудительное завершение процесса (Kill process).
    *   Откат процесса к контрольной точке (Rollback).
    *   Отбор ресурсов (Preemption).
